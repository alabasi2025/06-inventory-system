// prisma/schema.prisma
// نظام المخزون والمشتريات - Inventory System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════
// التصنيفات - Categories
// ═══════════════════════════════════════════════════
model InvCategory {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameEn      String?
  parentId    String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  parent      InvCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    InvCategory[] @relation("CategoryHierarchy")
  items       InvItem[]
  
  @@map("inv_categories")
}

// ═══════════════════════════════════════════════════
// وحدات القياس - Units
// ═══════════════════════════════════════════════════
model InvUnit {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameEn      String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  items       InvItem[]
  grnItems    InvGrnItem[] @relation("GrnItemUnit")
  
  @@map("inv_units")
}

// ═══════════════════════════════════════════════════
// المستودعات - Warehouses
// ═══════════════════════════════════════════════════
model InvWarehouse {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  nameEn      String?
  type        String   @default("main") // main, sub, transit
  stationId   String?
  address     String?
  managerId   String?
  phone       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  stocks        InvStock[]
  movementsFrom InvMovement[] @relation("FromWarehouse")
  movementsTo   InvMovement[] @relation("ToWarehouse")
  grns          InvGoodsReceivedNote[] @relation("WarehouseGRNs")
  
  @@map("inv_warehouses")
}

// ═══════════════════════════════════════════════════
// الأصناف - Items
// ═══════════════════════════════════════════════════
model InvItem {
  id            String   @id @default(uuid())
  code          String   @unique
  barcode       String?  @unique
  name          String
  nameEn        String?
  categoryId    String
  unitId        String
  description   String?
  minStock      Decimal  @default(0) @db.Decimal(18,4)
  maxStock      Decimal? @db.Decimal(18,4)
  reorderPoint  Decimal? @db.Decimal(18,4)
  reorderQty    Decimal? @db.Decimal(18,4)
  avgCost       Decimal  @default(0) @db.Decimal(18,4)
  lastCost      Decimal  @default(0) @db.Decimal(18,4)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  category      InvCategory @relation(fields: [categoryId], references: [id])
  unit          InvUnit @relation(fields: [unitId], references: [id])
  stocks        InvStock[]
  movementItems InvMovementItem[]
  poItems       InvPurchaseOrderItem[]
  prItems       InvPurchaseRequestItem[]
  grnItems      InvGrnItem[]
  
  @@map("inv_items")
}

// ═══════════════════════════════════════════════════
// أرصدة المخزون - Stock
// ═══════════════════════════════════════════════════
model InvStock {
  id            String   @id @default(uuid())
  warehouseId   String
  itemId        String
  quantity      Decimal  @default(0) @db.Decimal(18,4)
  reservedQty   Decimal  @default(0) @db.Decimal(18,4)
  avgCost       Decimal  @default(0) @db.Decimal(18,4)
  lastUpdated   DateTime @default(now())
  
  warehouse     InvWarehouse @relation(fields: [warehouseId], references: [id])
  item          InvItem @relation(fields: [itemId], references: [id])
  
  @@unique([warehouseId, itemId])
  @@map("inv_stocks")
}

// ═══════════════════════════════════════════════════
// الموردين - Suppliers
// ═══════════════════════════════════════════════════
model InvSupplier {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String
  nameEn         String?
  type           String   @default("local") // local, international
  category       String   @default("C") // A, B, C
  taxNumber      String?
  crNumber       String?
  phone          String?
  mobile         String?
  email          String?
  website        String?
  address        String?
  city           String?
  country        String   @default("SA")
  contactPerson  String?
  contactPhone   String?
  paymentTerms   Int      @default(30)
  creditLimit    Decimal  @default(0) @db.Decimal(18,2)
  currentBalance Decimal  @default(0) @db.Decimal(18,2)
  rating         Decimal? @db.Decimal(3,2)
  notes          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  contracts      InvSupplierContract[]
  purchaseOrders InvPurchaseOrder[]
  grns           InvGoodsReceivedNote[] @relation("SupplierGRNs")
  
  @@map("inv_suppliers")
}

// ═══════════════════════════════════════════════════
// عقود الموردين - Supplier Contracts
// ═══════════════════════════════════════════════════
model InvSupplierContract {
  id            String   @id @default(uuid())
  contractNo    String   @unique
  supplierId    String
  title         String
  startDate     DateTime
  endDate       DateTime
  value         Decimal  @db.Decimal(18,2)
  terms         String?
  attachmentUrl String?
  status        String   @default("active") // draft, active, expired, terminated
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  supplier      InvSupplier @relation(fields: [supplierId], references: [id])
  
  @@map("inv_supplier_contracts")
}

// ═══════════════════════════════════════════════════
// حركات المخزون - Movements
// ═══════════════════════════════════════════════════
model InvMovement {
  id              String   @id @default(uuid())
  movementNo      String   @unique
  type            String   // receipt, issue, transfer, adjustment
  fromWarehouseId String?
  toWarehouseId   String?
  referenceType   String?  // PO, WO, SO, ADJ
  referenceId     String?
  movementDate    DateTime @default(now())
  notes           String?
  status          String   @default("draft") // draft, confirmed, cancelled
  totalAmount     Decimal  @default(0) @db.Decimal(18,2)
  createdBy       String
  confirmedBy     String?
  confirmedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  fromWarehouse   InvWarehouse? @relation("FromWarehouse", fields: [fromWarehouseId], references: [id])
  toWarehouse     InvWarehouse? @relation("ToWarehouse", fields: [toWarehouseId], references: [id])
  items           InvMovementItem[]
  
  @@map("inv_movements")
}

// ═══════════════════════════════════════════════════
// بنود حركات المخزون - Movement Items
// ═══════════════════════════════════════════════════
model InvMovementItem {
  id          String   @id @default(uuid())
  movementId  String
  itemId      String
  quantity    Decimal  @db.Decimal(18,4)
  unitCost    Decimal  @default(0) @db.Decimal(18,4)
  totalCost   Decimal  @default(0) @db.Decimal(18,2)
  notes       String?
  
  movement    InvMovement @relation(fields: [movementId], references: [id], onDelete: Cascade)
  item        InvItem @relation(fields: [itemId], references: [id])
  
  @@map("inv_movement_items")
}

// ═══════════════════════════════════════════════════
// طلبات الشراء - Purchase Requests
// ═══════════════════════════════════════════════════
model InvPurchaseRequest {
  id            String   @id @default(uuid())
  requestNo     String   @unique
  requestDate   DateTime @default(now())
  requiredDate  DateTime?
  departmentId  String?
  requesterId   String
  priority      String   @default("normal") // low, normal, high, urgent
  notes         String?
  status        String   @default("draft") // draft, pending, approved, rejected, converted
  totalAmount   Decimal  @default(0) @db.Decimal(18,2)
  approvedBy    String?
  approvedAt    DateTime?
  rejectedBy    String?
  rejectedAt    DateTime?
  rejectionReason String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  items         InvPurchaseRequestItem[]
  
  @@map("inv_purchase_requests")
}

// ═══════════════════════════════════════════════════
// بنود طلبات الشراء - Purchase Request Items
// ═══════════════════════════════════════════════════
model InvPurchaseRequestItem {
  id          String   @id @default(uuid())
  requestId   String
  itemId      String
  quantity    Decimal  @db.Decimal(18,4)
  estUnitCost Decimal? @db.Decimal(18,4)
  estTotalCost Decimal? @db.Decimal(18,2)
  notes       String?
  
  request     InvPurchaseRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  item        InvItem @relation(fields: [itemId], references: [id])
  
  @@map("inv_purchase_request_items")
}

// ═══════════════════════════════════════════════════
// أوامر الشراء - Purchase Orders
// ═══════════════════════════════════════════════════
model InvPurchaseOrder {
  id            String   @id @default(uuid())
  orderNo       String   @unique
  supplierId    String
  orderDate     DateTime @default(now())
  expectedDate  DateTime?
  warehouseId   String?
  paymentTerms  Int      @default(30)
  currency      String   @default("SAR")
  exchangeRate  Decimal  @default(1) @db.Decimal(10,4)
  subtotal      Decimal  @default(0) @db.Decimal(18,2)
  taxAmount     Decimal  @default(0) @db.Decimal(18,2)
  discountAmount Decimal @default(0) @db.Decimal(18,2)
  totalAmount   Decimal  @default(0) @db.Decimal(18,2)
  notes         String?
  status        String   @default("draft") // draft, pending, approved, sent, partial, received, cancelled
  createdBy     String
  approvedBy    String?
  approvedAt    DateTime?
  sentAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  supplier      InvSupplier @relation(fields: [supplierId], references: [id])
  items         InvPurchaseOrderItem[]
  
  @@map("inv_purchase_orders")
}

// ═══════════════════════════════════════════════════
// بنود أوامر الشراء - Purchase Order Items
// ═══════════════════════════════════════════════════
model InvPurchaseOrderItem {
  id            String   @id @default(uuid())
  orderId       String
  itemId        String
  quantity      Decimal  @db.Decimal(18,4)
  receivedQty   Decimal  @default(0) @db.Decimal(18,4)
  unitPrice     Decimal  @db.Decimal(18,4)
  taxRate       Decimal  @default(15) @db.Decimal(5,2)
  taxAmount     Decimal  @default(0) @db.Decimal(18,2)
  discountRate  Decimal  @default(0) @db.Decimal(5,2)
  discountAmount Decimal @default(0) @db.Decimal(18,2)
  totalAmount   Decimal  @db.Decimal(18,2)
  notes         String?
  
  order         InvPurchaseOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  item          InvItem @relation(fields: [itemId], references: [id])
  
  @@map("inv_purchase_order_items")
}


// ═══════════════════════════════════════════════════
// سندات استلام البضائع - Goods Received Notes (GRN)
// ═══════════════════════════════════════════════════
model InvGoodsReceivedNote {
  id                  String   @id @default(uuid())
  grnNumber           String   @unique
  grnDate             DateTime @default(now())
  
  purchaseOrderId     String?
  supplierId          String
  warehouseId         String
  
  // معلومات الشحنة
  deliveryNoteNumber  String?
  invoiceNumber       String?
  vehicleNumber       String?
  driverName          String?
  
  notes               String?
  
  status              String   @default("draft") // draft, inspected, accepted, rejected, partial
  
  receivedBy          String?
  inspectedBy         String?
  inspectedAt         DateTime?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  supplier            InvSupplier @relation("SupplierGRNs", fields: [supplierId], references: [id])
  warehouse           InvWarehouse @relation("WarehouseGRNs", fields: [warehouseId], references: [id])
  items               InvGrnItem[]
  
  @@map("inv_goods_received_notes")
}

// ═══════════════════════════════════════════════════
// بنود سندات الاستلام - GRN Items
// ═══════════════════════════════════════════════════
model InvGrnItem {
  id                String   @id @default(uuid())
  grnId             String
  itemId            String
  
  orderedQuantity   Decimal  @default(0) @db.Decimal(18,4)
  receivedQuantity  Decimal  @db.Decimal(18,4)
  acceptedQuantity  Decimal  @default(0) @db.Decimal(18,4)
  rejectedQuantity  Decimal  @default(0) @db.Decimal(18,4)
  
  unitId            String
  unitCost          Decimal  @default(0) @db.Decimal(18,4)
  
  // التتبع
  batchNumber       String?
  serialNumbers     String?  // JSON array of serial numbers
  expiryDate        DateTime?
  
  // الفحص
  inspectionStatus  String   @default("pending") // pending, passed, failed, partial
  rejectionReason   String?
  
  notes             String?
  createdAt         DateTime @default(now())
  
  grn               InvGoodsReceivedNote @relation(fields: [grnId], references: [id], onDelete: Cascade)
  item              InvItem @relation(fields: [itemId], references: [id])
  unit              InvUnit @relation("GrnItemUnit", fields: [unitId], references: [id])
  
  @@map("inv_grn_items")
}
