// نظام المخزون والمشتريات

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ==================== التصنيفات (Categories) ====================
model inv_categories {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(50)
  name        String   @db.VarChar(200)
  name_en     String?  @db.VarChar(200)
  parent_id   String?  @db.Uuid
  level       Int      @default(1)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  parent      inv_categories?  @relation("CategoryHierarchy", fields: [parent_id], references: [id])
  children    inv_categories[] @relation("CategoryHierarchy")
  items       inv_items[]
}

// ==================== وحدات القياس (Units of Measure) ====================
model inv_units {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(20)
  name        String   @db.VarChar(100)
  name_en     String?  @db.VarChar(100)
  symbol      String   @db.VarChar(10)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  items       inv_items[]
}

// ==================== المستودعات (Warehouses) ====================
model inv_warehouses {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(50)
  name        String   @db.VarChar(200)
  name_en     String?  @db.VarChar(200)
  type        String   @db.VarChar(20)
  station_id  String?  @db.Uuid
  address     String?  @db.Text
  manager_id  String?  @db.Uuid
  phone       String?  @db.VarChar(20)
  email       String?  @db.VarChar(100)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  warehouse_items      inv_warehouse_items[]
  movements_from       inv_movements[]       @relation("WarehouseMovements")
  movements_to         inv_movements[]       @relation("ToWarehouseMovements")
  purchase_orders      inv_purchase_orders[]
  purchase_requests    inv_purchase_requests[]
}

// ==================== الأصناف (Items) ====================
model inv_items {
  id              String   @id @default(uuid()) @db.Uuid
  code            String   @unique @db.VarChar(50)
  name            String   @db.VarChar(200)
  name_en         String?  @db.VarChar(200)
  description     String?  @db.Text
  category_id     String   @db.Uuid
  unit_id         String   @db.Uuid
  barcode         String?  @db.VarChar(50)
  min_stock       Decimal  @default(0) @db.Decimal(18, 4)
  max_stock       Decimal? @db.Decimal(18, 4)
  reorder_point   Decimal? @db.Decimal(18, 4)
  reorder_qty     Decimal? @db.Decimal(18, 4)
  avg_cost        Decimal  @default(0) @db.Decimal(18, 4)
  last_cost       Decimal  @default(0) @db.Decimal(18, 4)
  standard_cost   Decimal? @db.Decimal(18, 4)
  is_serialized   Boolean  @default(false)
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  category        inv_categories @relation(fields: [category_id], references: [id])
  unit            inv_units @relation(fields: [unit_id], references: [id])
  warehouse_items inv_warehouse_items[]
  movement_items  inv_movement_items[]
  pr_items        inv_purchase_request_items[]
  po_items        inv_purchase_order_items[]
  quotation_items inv_quotation_items[]
}

// ==================== أرصدة المخزون (Warehouse Items / Stock) ====================
model inv_warehouse_items {
  id            String   @id @default(uuid()) @db.Uuid
  warehouse_id  String   @db.Uuid
  item_id       String   @db.Uuid
  quantity      Decimal  @default(0) @db.Decimal(18, 4)
  available_qty Decimal  @default(0) @db.Decimal(18, 4)
  reserved_qty  Decimal  @default(0) @db.Decimal(18, 4)
  avg_cost      Decimal  @default(0) @db.Decimal(18, 4)
  last_updated  DateTime @default(now())

  warehouse     inv_warehouses @relation(fields: [warehouse_id], references: [id])
  item          inv_items @relation(fields: [item_id], references: [id])

  @@unique([warehouse_id, item_id])
}

// ==================== الموردين (Suppliers) ====================
model inv_suppliers {
  id              String   @id @default(uuid()) @db.Uuid
  code            String   @unique @db.VarChar(50)
  name            String   @db.VarChar(200)
  name_en         String?  @db.VarChar(200)
  type            String   @db.VarChar(20)
  category        String   @db.VarChar(10)
  tax_number      String?  @db.VarChar(50)
  cr_number       String?  @db.VarChar(50)
  phone           String?  @db.VarChar(20)
  mobile          String?  @db.VarChar(20)
  email           String?  @db.VarChar(100)
  website         String?  @db.VarChar(200)
  address         String?  @db.Text
  city            String?  @db.VarChar(100)
  country         String?  @db.VarChar(100)
  contact_person  String?  @db.VarChar(100)
  contact_phone   String?  @db.VarChar(20)
  payment_terms   Int      @default(30)
  credit_limit    Decimal  @default(0) @db.Decimal(18, 2)
  rating          Decimal? @db.Decimal(3, 2)
  notes           String?  @db.Text
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  contracts       inv_supplier_contracts[]
  quotations      inv_quotations[]
  purchase_orders inv_purchase_orders[]
}

// ==================== عقود الموردين (Supplier Contracts) ====================
model inv_supplier_contracts {
  id            String    @id @default(uuid()) @db.Uuid
  supplier_id   String    @db.Uuid
  contract_no   String    @unique @db.VarChar(50)
  title         String    @db.VarChar(200)
  start_date    DateTime  @db.Date
  end_date      DateTime  @db.Date
  value         Decimal   @db.Decimal(18, 2)
  terms         String?   @db.Text
  attachment    String?   @db.VarChar(500)
  status        String    @default("active") @db.VarChar(20)
  created_by    String?   @db.Uuid
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  supplier      inv_suppliers @relation(fields: [supplier_id], references: [id])
}

// ==================== حركات المخزون (Inventory Movements) ====================
model inv_movements {
  id              String    @id @default(uuid()) @db.Uuid
  movement_no     String    @unique @db.VarChar(50)
  type            String    @db.VarChar(20)
  warehouse_id    String    @db.Uuid
  to_warehouse_id String?   @db.Uuid
  reference_type  String?   @db.VarChar(50)
  reference_id    String?   @db.Uuid
  movement_date   DateTime  @default(now())
  total_cost      Decimal   @default(0) @db.Decimal(18, 2)
  status          String    @default("draft") @db.VarChar(20)
  notes           String?   @db.Text
  created_by      String?   @db.Uuid
  confirmed_by    String?   @db.Uuid
  confirmed_at    DateTime?
  cancelled_by    String?   @db.Uuid
  cancelled_at    DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  warehouse       inv_warehouses @relation("WarehouseMovements", fields: [warehouse_id], references: [id])
  to_warehouse    inv_warehouses? @relation("ToWarehouseMovements", fields: [to_warehouse_id], references: [id])
  items           inv_movement_items[]
}

// ==================== تفاصيل حركة المخزون (Movement Items) ====================
model inv_movement_items {
  id            String    @id @default(uuid()) @db.Uuid
  movement_id   String    @db.Uuid
  item_id       String    @db.Uuid
  quantity      Decimal   @db.Decimal(18, 4)
  unit_cost     Decimal   @db.Decimal(18, 4)
  total_cost    Decimal   @db.Decimal(18, 2)
  batch_no      String?   @db.VarChar(50)
  serial_no     String?   @db.VarChar(100)
  expiry_date   DateTime? @db.Date
  notes         String?   @db.Text

  movement      inv_movements @relation(fields: [movement_id], references: [id], onDelete: Cascade)
  item          inv_items @relation(fields: [item_id], references: [id])
}

// ==================== طلبات الشراء (Purchase Requests) ====================
model inv_purchase_requests {
  id               String    @id @default(uuid()) @db.Uuid
  request_no       String    @unique @db.VarChar(50)
  warehouse_id     String    @db.Uuid
  department_id    String?   @db.Uuid
  priority         String    @default("medium") @db.VarChar(20)
  required_date    DateTime? @db.Date
  reason           String?   @db.Text
  total_estimated  Decimal   @default(0) @db.Decimal(18, 2)
  status           String    @default("draft") @db.VarChar(20)
  notes            String?   @db.Text
  created_by       String?   @db.Uuid
  submitted_by     String?   @db.Uuid
  submitted_at     DateTime?
  approved_by      String?   @db.Uuid
  approved_at      DateTime?
  approval_notes   String?   @db.Text
  rejected_by      String?   @db.Uuid
  rejected_at      DateTime?
  rejection_reason String?   @db.Text
  cancelled_by     String?   @db.Uuid
  cancelled_at     DateTime?
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  warehouse        inv_warehouses @relation(fields: [warehouse_id], references: [id])
  items            inv_purchase_request_items[]
  quotations       inv_quotations[]
}

// ==================== تفاصيل طلب الشراء (PR Items) ====================
model inv_purchase_request_items {
  id              String   @id @default(uuid()) @db.Uuid
  request_id      String   @db.Uuid
  item_id         String   @db.Uuid
  quantity        Decimal  @db.Decimal(18, 4)
  estimated_price Decimal  @default(0) @db.Decimal(18, 4)
  notes           String?  @db.Text

  request         inv_purchase_requests @relation(fields: [request_id], references: [id], onDelete: Cascade)
  item            inv_items @relation(fields: [item_id], references: [id])
}

// ==================== عروض الأسعار (Quotations) ====================
model inv_quotations {
  id               String    @id @default(uuid()) @db.Uuid
  quotation_no     String    @unique @db.VarChar(50)
  request_id       String?   @db.Uuid
  supplier_id      String    @db.Uuid
  valid_until      DateTime? @db.Date
  payment_terms    String?   @db.VarChar(200)
  delivery_terms   String?   @db.VarChar(200)
  subtotal         Decimal   @default(0) @db.Decimal(18, 2)
  discount_amount  Decimal   @default(0) @db.Decimal(18, 2)
  tax_percent      Decimal   @default(15) @db.Decimal(5, 2)
  tax_amount       Decimal   @default(0) @db.Decimal(18, 2)
  total_amount     Decimal   @default(0) @db.Decimal(18, 2)
  status           String    @default("pending") @db.VarChar(20)
  notes            String?   @db.Text
  received_at      DateTime?
  accepted_by      String?   @db.Uuid
  accepted_at      DateTime?
  created_by       String?   @db.Uuid
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  request          inv_purchase_requests? @relation(fields: [request_id], references: [id])
  supplier         inv_suppliers @relation(fields: [supplier_id], references: [id])
  items            inv_quotation_items[]
  purchase_orders  inv_purchase_orders[]
}

// ==================== تفاصيل عرض السعر (Quotation Items) ====================
model inv_quotation_items {
  id               String   @id @default(uuid()) @db.Uuid
  quotation_id     String   @db.Uuid
  item_id          String   @db.Uuid
  quantity         Decimal  @db.Decimal(18, 4)
  unit_price       Decimal  @db.Decimal(18, 4)
  discount_percent Decimal  @default(0) @db.Decimal(5, 2)
  discount_amount  Decimal  @default(0) @db.Decimal(18, 2)
  total_price      Decimal  @db.Decimal(18, 2)
  delivery_days    Int?
  notes            String?  @db.Text

  quotation        inv_quotations @relation(fields: [quotation_id], references: [id], onDelete: Cascade)
  item             inv_items @relation(fields: [item_id], references: [id])
}

// ==================== أوامر الشراء (Purchase Orders) ====================
model inv_purchase_orders {
  id                  String    @id @default(uuid()) @db.Uuid
  order_no            String    @unique @db.VarChar(50)
  quotation_id        String?   @db.Uuid
  supplier_id         String    @db.Uuid
  warehouse_id        String    @db.Uuid
  expected_date       DateTime? @db.Date
  payment_terms       String?   @db.VarChar(200)
  delivery_terms      String?   @db.VarChar(200)
  subtotal            Decimal   @default(0) @db.Decimal(18, 2)
  discount_amount     Decimal   @default(0) @db.Decimal(18, 2)
  tax_percent         Decimal   @default(15) @db.Decimal(5, 2)
  tax_amount          Decimal   @default(0) @db.Decimal(18, 2)
  total_amount        Decimal   @default(0) @db.Decimal(18, 2)
  status              String    @default("draft") @db.VarChar(20)
  notes               String?   @db.Text
  created_by          String?   @db.Uuid
  approved_by         String?   @db.Uuid
  approved_at         DateTime?
  sent_at             DateTime?
  cancelled_by        String?   @db.Uuid
  cancelled_at        DateTime?
  cancellation_reason String?   @db.Text
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  quotation           inv_quotations? @relation(fields: [quotation_id], references: [id])
  supplier            inv_suppliers @relation(fields: [supplier_id], references: [id])
  warehouse           inv_warehouses @relation(fields: [warehouse_id], references: [id])
  items               inv_purchase_order_items[]
  receipts            inv_goods_receipts[]
}

// ==================== تفاصيل أمر الشراء (PO Items) ====================
model inv_purchase_order_items {
  id               String   @id @default(uuid()) @db.Uuid
  order_id         String   @db.Uuid
  item_id          String   @db.Uuid
  quantity         Decimal  @db.Decimal(18, 4)
  received_qty     Decimal  @default(0) @db.Decimal(18, 4)
  unit_price       Decimal  @db.Decimal(18, 4)
  discount_percent Decimal  @default(0) @db.Decimal(5, 2)
  discount_amount  Decimal  @default(0) @db.Decimal(18, 2)
  total_price      Decimal  @db.Decimal(18, 2)
  notes            String?  @db.Text

  order            inv_purchase_orders @relation(fields: [order_id], references: [id], onDelete: Cascade)
  item             inv_items @relation(fields: [item_id], references: [id])
  receipt_items    inv_goods_receipt_items[]
}

// ==================== محاضر الاستلام (Goods Receipts) ====================
model inv_goods_receipts {
  id                  String    @id @default(uuid()) @db.Uuid
  receipt_no          String    @unique @db.VarChar(50)
  order_id            String    @db.Uuid
  receipt_date        DateTime  @default(now())
  gate_pass_no        String?   @db.VarChar(50)
  supplier_invoice_no String?   @db.VarChar(50)
  status              String    @default("draft") @db.VarChar(20)
  notes               String?   @db.Text
  created_by          String?   @db.Uuid
  confirmed_by        String?   @db.Uuid
  confirmed_at        DateTime?
  cancelled_by        String?   @db.Uuid
  cancelled_at        DateTime?
  created_at          DateTime  @default(now())
  updated_at          DateTime  @updatedAt

  order               inv_purchase_orders @relation(fields: [order_id], references: [id])
  items               inv_goods_receipt_items[]
}

// ==================== تفاصيل محضر الاستلام (GR Items) ====================
model inv_goods_receipt_items {
  id               String    @id @default(uuid()) @db.Uuid
  receipt_id       String    @db.Uuid
  order_item_id    String    @db.Uuid
  received_qty     Decimal   @db.Decimal(18, 4)
  rejected_qty     Decimal   @default(0) @db.Decimal(18, 4)
  rejection_reason String?   @db.Text
  batch_no         String?   @db.VarChar(50)
  serial_no        String?   @db.VarChar(100)
  expiry_date      DateTime? @db.Date
  notes            String?   @db.Text

  receipt          inv_goods_receipts @relation(fields: [receipt_id], references: [id], onDelete: Cascade)
  order_item       inv_purchase_order_items @relation(fields: [order_item_id], references: [id])
}

// ==================== التسلسل (Sequences) ====================
model inv_sequences {
  id          String   @id @default(uuid()) @db.Uuid
  type        String   @db.VarChar(20)
  prefix      String   @db.VarChar(10)
  year        Int
  current_no  Int      @default(0)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@unique([type, year])
}
